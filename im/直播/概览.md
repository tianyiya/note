# 基于HTTP轮训的弹幕系统

## 基础操作

> 进入直播间

zadd添加到直播间列表中，同时从其它直播间订阅列表中删除

> 获取直播间成员

zrange 0 -1 获取所有成员

> 发送消息

zadd添加消息，score为消息的相对时间，相对于视频或直播的开始时间或当前播放时间的时间值

10s表示视频开始10s的弹幕

> 获取消息

每两秒轮询，zrangebyscore 

对于大直播间，需要进行分key，防止出现大key的情况。

## 如何保证弹幕数据不丢失

客户端发送弹幕时，根据房间ID，将弹幕保存到MQ的同一个分区，这样下游服务获取时，
就可以顺序获取弹幕数据，并顺序给弹幕设置上相对时间，然后保存到redis中，
。获取弹幕时，根据弹幕的相对时间进行获取

## 性能优化

大量弹幕的场景，如何使用串行的方式处理一个房间内的弹幕数据，可能会在成较大延迟
。因此，此时需要牺牲掉一定的数据可靠性，保证弹幕的实时性。也就是，允许丢失一部分弹幕数据。
当然，对于一些榜上大哥发送的弹幕，可能要确保不丢失，此时可见这部分数据依旧按照之前的方式处理

> 根据不同的延迟级别进行不同的处理

如何获取延迟时间，接入层为弹幕打上时间戳后发送到MQ，业务处理层消费消息时减去时间戳
获取延迟，根据不同的延迟选择不同的等级

分别为延迟高时的多个partition和不加锁消费 & 延迟低时的一个partition和加锁消费

笛卡尔积公4个等级

业务处理层计算出延迟等级变更后，需要有机制通知接入层，以便接入层获取最新的延迟等级，可以使用通知的方式配置中心的方式

> 避免频繁的从redis获取弹幕信息

对于弹幕这等实时性强的数据，可以使用接入层缓存的方式，当然，由于实时性，仅需要缓存最近几秒的数据即可

对于小直播间，可以缓存相对比较大的时间跨度；对于大直播间，缓存较小的时间跨度，避免消息过多

其实不论大小直播间吧，均限制较小的时间间隔，省的还要去判断是不是大直播间 ^_^

> 弹幕回放

避免弹幕回放竞争redis资源

直播完毕，弹幕数据备份到mysql

同时，将弹幕数据保存到其他的回放redis

localcache > redis > mysql

回放仅仅选择部分弹幕

```
时间范围：选择在视频播放时间范围内发送的弹幕，而忽略播放前或播放后发送的弹幕。
热度排序：根据弹幕的点赞数或评论数进行排序，选择热度较高的弹幕。
审核筛选：对弹幕进行人工或机器审核，筛选出不违反平台规定且内容质量较高的弹幕。
主题相关：根据视频主题或关键词筛选出与主题相关的弹幕，避免选择无关或不合适的弹幕。
```

## 高可用方案

> 多机房

![容灾](http://www.52im.net/data/attachment/forum/201711/28/123103iatgtsgzpgp0mfmv.jpeg)

> 服务端如何实时通知客户端修改轮询时间？

我理解的是客户端定时获取轮询频率

> 降级

服务端出现高峰或网络等异常时，可限制客户端投递弹幕的速率。

限制拉取弹幕的数目，

> 直播回放弹幕自动降级

回放的弹幕是和视频直接打包在一起了么

> 容灾队列

容灾队列与原队列部署在不同的集群

- 消费容灾队列，重新投递到原队列
- 消费容灾队列，重新处理业务逻辑，将结果投递容灾队列
- 数据量大时的高级数据迁移方式

> 丢弃不重要的弹幕

```
根据用户互动情况：如果某个弹幕消息引起了用户的热议或者互动，比如点赞、评论等，那么这个弹幕消息很可能就比较重要，需要优先处理和展示。
根据内容和关键词：对于某些具有特定含义或者关键词的弹幕消息，比如重要公告、重大新闻、活动信息等，可以根据关键词来识别和标记这些消息，并进行优先处理和展示。
根据发送者身份和活跃度：如果某个用户在弹幕系统中拥有很高的活跃度或者身份地位，比如是VIP用户、超级粉丝或者系统管理员，那么他发送的弹幕消息很可能也比较重要，需要优先处理和展示。
根据弹幕消息的类型和频率：如果某种类型的弹幕消息出现频率较高，或者一段时间内发送了很多类似的弹幕消息，那么这些弹幕消息可能就比较普通，不是很重要，可以降低处理优先级。
```

也就是弹幕要先经过优先级评级

# 长连接实现

用户进入房间，也就是用户临时订阅了房间

当房间有弹幕的时候，业务层查询房间的订阅者，广播弹幕到接入层。当然，数据量小的时候，可以通过查询用户所在网关机进行更精确的推送。



