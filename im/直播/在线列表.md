## 用户进入房间与离开房间

如何得知用户进入房间与离开房间

1. 客户端主动上报
2. 通过心跳信息维护，通过心跳解析用户所在的房间，心跳超时则离开房间
3. 日志分析，实时分析日志
4. 事件监听，监听套接字状态，感知离线

多种方式可共同使用

## 在线列表的维护

### 不同大小的直播间，在线状态维护可使用不同方案

对于小直播间，可直接使用zset维护

对于稍大一点的，可以使用redis分多个key的方式

而对于超大的，则需要引入专门的在线状态维护服务进行维护

### 方案

大体流程如下，

1. 在线状态设置

客户端上报心跳后，由一致性哈希交由一台状态服务处理

状态服务再对用户进行二次hash，本地形成更多的分片

状态服务仅更新内存

异步清除心跳超时的用户，也就是从本地列表中删除，并序列化列表保存到分布式缓存中。当然缓存要设置有效时间

2. 在线状态获取

状态服务异步拉取所有key的数据，并在本地聚合


> 优化项

状态服务本地聚合用户上下线变更，避免频繁操作分布式缓存

维护读写列表，使用原子切换

### 在线列表的增量获取

但是，为了增量获取在线列表，似乎并不能直接层在线列表中删除，可以先打个离线标记，并序列化列表保存到分布式缓存中。当然缓存要设置有效时间


用户增量获取在线列表，这就需要暂时保留离线的用户，当离线的时间达到阈值时，可以认为客户端均已经获取到，可删除
，以便用户能够增量的获取到

在线列表，不能通过弹幕的方式，将入房间，离开房间的事件返回给客户端么。我觉得可以本地缓存一个上线下线的时间队列，
可以仅保留最新的数据，当客户端来获取时，如果上次更新时间过早，则需要全量更新，否则，可以通过获取事件列表增量更新
。当然，增量更新请求也可以是事件的版本，如果版本不再缓存队列，则全量获取。