# 名词介绍

- recvsvr

缓存直播间信息，可加速获取直播间信息的速率，同时避免对存储层的读取压力

# 方案

## recvsvr分组

直播间数量多时，可以将服务分组，每组服务共同服务于一范围内的群组

通过一致性hash算法路由到具体分组

## 变更通知

保存直播间数据后，主动通知recvsvr，recvsvr异步拉取最新消息

如何通知？

1. 获知分组内的所有服务，遍历通知
2. 每个分组一个topic，分组内的每个服务都是一个消费group，以达到广播的功能
3. 仅通知一个分组内的一个服务，分组内的服务实现数据同步


## 轮询兜底

为了防止通知失效，可主动发起获取消息

触发主动获取的条件？

当recvsvr收取到客户端请求时，则触发1s的定时轮询，当一段时间没有收到客户端请求时，可以取消定时轮询

如何实现？

开启一个定时任务，获取上次客户端请求的时间，如果超时，则取消任务

## 无锁化

recvsvr读写表分离，读写表切换后，需要将原写表（新读表）里的数据补全到原读表（新写表），也就是，切换完的瞬间，两笔数据可能不一致

读写表原子切换的时机？

1. 时间阈值
2. 容量阈值

## Q&A

> recvsvr容量的问题

recvsvr需要有内存淘汰策略，比如依据容量或者依据时间。

所有对于一些重要的消息，需要单独处理，避免丢失

