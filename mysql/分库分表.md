# 一、方案

## （一）、从库法

适用于表结构不变，双倍扩容

1. 添加一个VIP B到主库
2. 添加分库分表规则，当然，此时VIP A和VIP B均操作主库
3. 停写，通过配置，停止写入
4. 待从库追赶上之后，从库升级为主，并添加新的主从，切换VIP B到新的主库，并开启写入

##  （二）、双写法

1. 开启双写，以主库是否成功为事务是否成功的依据

对于插入操作，插入就好了
对于删除操作，双写需要写入墓碑消息，存量同步时，墓碑消息不同步
对于修改操作，如果新库没有，则查询老库后插入

2. 存量数据同步，同步到双写之后的一个时间点，已确保数据全部同步

仅需要插入新库不存在的数据，包括双写后新库插入的、修改的以及删除的

3. 数据校验，全量校验及实时校验

## （三）、binlog同步

1. 开启双向同步，先不消费kafka
2. 同步存量数据
3. 开启kafka，消费数据
4. 灰度切流，切流前先短暂停写，保证kafka消费完
5. 关闭停写

---

500台出租车，假设每天20小时，则产生60w每天

0.05*20*60 = 60w

60w * 365 = 2.2亿

----

50-60w用户

30w用户，一天5条消息，一年5亿

包含系统消息，IM消息，IM群组

系统消息使用单独的存储，选取满足某些条件的人，推送，写扩散

系统消息表

包含车辆信息，流量信息，活动信息等

```dtd
标题
附标题
消息类型
消息内容
...
```

单聊消息，一天几十w吧

读扩散模型

300000/10/60 并发500

300000/60 并发5000 单机2500

