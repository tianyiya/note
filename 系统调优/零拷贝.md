# 一、linux中的零拷贝

## （一）、普通拷贝

1. 用户态read调用，陷入内核态
2. DMA拷贝磁盘数据到内核缓冲区
3. CPU拷贝内核缓冲区数据到用户缓冲器，同时切换到用户态
4. 用户态write调用，切换到内核态，CPU拷贝用户缓冲区数据到socket缓冲区
5. DMA异步拷贝socket缓冲区数据到网卡
6. write返回，切换到用户态

需要4次切换，4次拷贝

## （二）、mmap

建立用户缓冲区到内核缓冲区的映射，即不需要CPU拷贝内核缓冲区数据到用户缓冲区

需要4次切换，3次拷贝

### 应用

`MappedByteBuffer` `DirectByteBuffer` 

适用于小文件传输，支持随机访问

支持随机访问

### rocketmq为什么使用mmap

RocketMQ 中的消息存储是通过将消息写入到文件中实现的，每个消息都会被写入到一个独立的文件中。

这些消息文件需要支持快速的随机访问，以便在需要读取或写入消息时能够高效地定位和操作特定的消息。

使用随机访问可以使 RocketMQ 在处理大量消息时能够快速、高效地定位和读取特定的消息，从而实现高吞吐量和低延迟的消息传递。

除了消息存储和读取之外，RocketMQ 还需要支持许多其他的高级功能，例如消息过滤、消息查询、消息轨迹等。

这些功能也需要支持高效的随机访问，以便能够快速定位和查询特定的消息。

因此，通过使用随机访问，RocketMQ 可以实现高效的消息存储、读取和查询等功能，从而提供可靠的、高吞吐量的消息传递服务。

## （三）、sendfile

`transferTo` `transferFrom`

仅需要拷贝offset和length数据到socket缓冲区

数据则直接从内核缓冲区DMA拷贝到网卡

2次切换，2次拷贝

### 应用

适用于大文件传输，设计socket的操作

如kafka中的`transferTo` `transferToFrom` 

不支持随机访问

# 参考文献

[Linux 零拷贝技术-mmap与sendFile](https://www.cnblogs.com/hongdada/p/16926179.html)